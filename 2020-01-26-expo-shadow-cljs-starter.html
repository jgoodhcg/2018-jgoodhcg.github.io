<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
    <meta charset="utf-8"/>
    <title>JGood: A template for Expo apps with Shadow CLJS</title>
    
<meta name="keywords" content="clojure,cljs,clj,vega,oz,expo,vega-lite,shadow-cljs,create-kit,npm">

<meta name="description" content="Do you want to make a native app? Are you familiar with a React stack? Do you also want to write in Clojure? Then the solution is -- Expo with Shadow CLJS. It&#39;s an easy technology transition and a well maintained platform to build on. I&#39;ve used Expo with plain Javascript at my day job for a couple of years. My most significant personal project is an Expo app written in CLJSWhy">

<meta property="og:description" content="Do you want to make a native app? Are you familiar with a React stack? Do you also want to write in Clojure? Then the solution is -- Expo with Shadow CLJS. It&#39;s an easy technology transition and a well maintained platform to build on. I&#39;ve used Expo with plain Javascript at my day job for a couple of years. My most significant personal project is an Expo app written in CLJSWhy">

<meta property="og:url" content="https://jgood.io/2020-01-26-expo-shadow-cljs-starter" />
<meta property="og:title" content="A template for Expo apps with Shadow CLJS" />
<meta property="og:type" content="article" />

    <link rel="canonical" href="https://jgood.io/2020-01-26-expo-shadow-cljs-starter">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="//fonts.googleapis.com/css?family=Alegreya:400italic,700italic,400,700" rel="stylesheet"
          type="text/css">
    <link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/bootstrap/3.3.0/css/bootstrap.min.css">
    <link href="//maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.7.0/styles/default.min.css">
    <link href="/css/screen.css" rel="stylesheet" type="text/css" />
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-74205906-2"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'UA-74205906-2');
    </script>
</head>
<body>


<nav class="navbar navbar-default">
    <div class="container">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            <a class="navbar-brand" href="/">JGood</a>
        </div>
        <div id="navbar" class="navbar-collapse collapse">
            <ul class="nav navbar-nav navbar-right">
                <li ><a href="/">Home</a></li>
                <li
                ><a href="/archives">Archives</a></li>
                
                <li
                >
                  <a href="/resume">Resume</a>
                </li>
                
                <li><a href="/feed.xml">RSS</a></li>
            </ul>
        </div><!--/.nav-collapse -->
    </div><!--/.container-fluid -->
</nav>


<div class="container">


    <div class="row">
        <div class="col-lg-9">
            <div id="content">
                
<div id="post">
    <div class="post-header">
    <div id="post-meta" class="row">
        <div class="col-lg-6">January 26, 2020</div>
        
    </div>
    <h2>A template for Expo apps with Shadow CLJS</h2>
</div>
<div>
    
    <p>Do you want to make a native app? Are you familiar with a React stack? Do you also want to write in Clojure? Then the solution is -- <a href="https://expo.io">Expo</a> with <a href="https://shadow-cljs.github.io/docs/UsersGuide.html">Shadow CLJS</a>. It's an easy technology transition and a well maintained platform to build on. I've used Expo with plain Javascript at my day job for a couple of years. My most significant personal project is an Expo app written in CLJS</p><h1>Why</h1><p>To be honest, I would prefer if the world ran on progressive web apps (PWAs).  If your project can fit within <a href="https://whatwebcando.today/">what web can do</a> then go for it.</p><p>However, sometimes a PWA won't cut it. Device capabilities like push notifications [^1] and geofencing are only available to native apps. The stores can also be a marketing boon.</p><p>My day job needed a native app and so did one of my personal projects. Geofence ability was an important feature for my personal project. My day job wanted a presence in the app stores and the ability to do push notifications to all users on iOS and Android.</p><p>For my personal projects I also <em>had</em> to use <a href="https://clojure.org/">Clojure</a>. Clojure is a great general language. <a href="https://clojure.org/about/rationale">There</a> are a <a href="https://youtu.be/BThkk5zv0DE">bunch</a> of <a href="https://news.ycombinator.com/item?id=20773921">reasons</a> to use it. There are a few flavors but I've been using ClojureScript (CLJS) the most. It compiles to Javascript. If you want to take your first steps with clojure I recommend <a href="http://www.4clojure.com/">these practice problems</a>, and a <a href="https://www.braveclojure.com/">few</a> general <a href="https://lambdaisland.com/">resources</a> for <a href="https://sekao.net/lightmod/">learning</a>. Here is a <a href="gist.github.com/yogthos/be323be0361c589570a6da4ccc85f58f">composite list of resources for beginners</a> from a prominent Clojure community member.</p><h1>How</h1><p>The goal of this post is to get you setup with a native app project that uses Expo and CLJS. To make it easy for you (and me) I made <a href="https://github.com/jgoodhcg/shadow-cljs-expo-starter">a template repository</a>. It has a selection of opinionated library choices that are <em>necessary</em> to make a real app.</p><h2>Tools</h2><p>Let's start with my system setup. I'm running <a href="https://system76.com/pop">PopOS</a>, which is almost the same as Ubuntu. <a href="https://www.spacemacs.org/">Spacemacs</a> is my editor of choice. I use <a href="https://github.com/syl20bnr/spacemacs/tree/master/layers/%2Blang/clojure">Cider</a> as my editor/CLJS integration.</p><p>To develop an Expo/CLJS project I have these things open the whole time:</p><ul><li>Browser (for <a href="https://docs.expo.io/versions/latest/workflow/debugging">debugging</a>)</li><li>Terminal for using the <a href="https://docs.expo.io/versions/latest/workflow/expo-cli/">Expo command line interface</a></li><li>Spacemacs for editing</li><li><a href="https://www.genymotion.com/">GenyMotion</a> for device emulation</li><li><a href="https://www.gitkraken.com/">GitKraken</a> for a GIT GUI [^2]</li></ul><h3>Get a running project</h3><p>Clone the repo first.</p><pre><code>$ git clone https://github.com/jgoodhcg/shadow-cljs-expo-starter.git
</code></pre><p>The <a href="https://dev.to/jr0cket/repl-driven-development-ano">REPL is one of the most important parts</a> of Clojure. However, the REPL experience isn't the best with Expo. Reloading the client application breaks the repl connection and the expo cli and cider will have to be restarted. Which happens semi frequently when working with visual stuff -- especially react components.</p><p>This is tolerable for me because I find that the repl is really only needed when I'm doing some experimental thing with state and actions, not visual components. So when I'm working on visual stuff I just don't pay much attention to the repl. When I want to do repl driven development it is normally with some non visual code and errors requiring reload rarely happen.</p><p>I normally start my project through the cider function <code>cider-jack-in-cljs</code> in the Clojure Spacemacs layer. It is too involved to go into depth here, and you probably don't want to use emacs anyway. So I urge you to explore integrating with the repl at some point in your native app development.</p><p>For this setup let's just use the command line to start Shadow compilation and Expo Javascript bundling. From the README:</p><pre><code class="language-bash">  # Install all deps
$ yarn
  # Start shadow-cljs
$ shadow-cljs watch app
  # Wait for first compile to finish or expo gets confused
  # (In another terminal) Start expo
$ yarn start
</code></pre><p><img src="./../../img/expo-shadow-cljs-starter/cli-start.png" alt="img" title="Starting expo and shadow-cljs" /></p><p>Open up Genymotion.
Install <a href="https://expo.io/tools#client">the Expo client app</a> if you don't have it. This client app is only for development. Expo provides a way to <a href="https://docs.expo.io/versions/latest/distribution/building-standalone-apps/">build binaries</a> for iOS and Android platforms.</p><p>Open the Expo client and select your app. You may want to create an Expo account and log in to be able to see it as an option.</p><p><img src="./../../img/expo-shadow-cljs-starter/genymotion-expo-client.png" alt="img" title="Expo client app project selection" /></p><p>The demo app will open up.</p><p><img src="./../../img/expo-shadow-cljs-starter/app.png" alt="img" title="Demo app running" /></p><p>Disable hot reloading and live reloading through the <a href="https://docs.expo.io/versions/latest/workflow/debugging/#developer-menu">dev menu</a> because Shadow CLJS already does this.</p><p><img src="./../../img/expo-shadow-cljs-starter/disable-reload.png" alt="img" title="Developer menu in app" /></p><h2>Opinions</h2><p>Now that you have a running app let's explore some of the libraries that are included.</p><h3>State management (re-frame)</h3><p><a href="https://github.com/day8/re-frame">Re-frame</a> is the standard state management for CLJS. If you are coming from Javascript it's like Redux but without the annoying boilerplate.</p><p>There is <em>app state</em>, in this project the default value is in <code>src/main/new_project_name/db.cljs</code>. It looks like this:</p><pre><code class="language-clojure">(def default-app-db
  {:settings {:theme :dark}
   :version  "version-not-set"})
</code></pre><p>When you are in the REPL the runtime value is accessable from <code>re-frame.db/app-db</code>.</p><p>Then there are <em>handlers</em>, in <code>src/main/new_project_name/handlers.cljs</code>, that allow for putting things into app state. Dispatched actions on user interactions triggers them.</p><pre><code class="language-clojure">;; handler definition and registration
(defn set-theme [db [_ theme]]
  (-&gt;&gt; db
       (setval [:settings :theme] theme)))
(reg-event-db :set-theme [spec-validation] set-theme)

;; dispatching an event, from a component, that is picked up by the handler
          [:&gt; paper/Switch {:value           (= theme-selection :dark)
                            :on-value-change #(&gt;evt [:set-theme (if (= theme-selection :dark)
                                                                  :light
                                                                  :dark)])}]]
</code></pre><p>The <code>:&gt;</code> macro is a <a href="http://reagent-project.github.io/docs/master/InteropWithReact.html">reagent react interop thing</a>. It takes the react class imported and wraps it around a reagent component.</p><p>There are <em>subscriptions</em>, in <code>src/main/new_project_name/subscriptions</code> that allow components to pull things out of state.</p><pre><code class="language-clojure">(defn theme [db _]
  (-&gt;&gt; db
       (select-one! [:settings :theme])))

(reg-sub :theme theme)
</code></pre><p>In the components these can be accessed with <code>(subscribe)</code>. There is a <a href="https://lambdaisland.com/blog/2017-02-11-re-frame-form-1-subscriptions">helper function</a> for these called <code>&lt;sub</code>. In <code>src/main/new_project_name</code> you can see it's usage.</p><pre><code class="language-clojure">(defn home-scene [props]
  (r/as-element
   (let [version         (&lt;sub [:version]) 
         theme-selection (&lt;sub [:theme]) ;; &lt;---------------------- use of the helper function to get a value out of app state
         theme           (.-theme props)]
     [:&gt; paper/Surface {:style (.-surface styles)}
      [:&gt; rn/View
       [:&gt; paper/Card
        [:&gt; paper/Card.Title {:title    "A nice Expo/Shadow-cljs template"
                              :subtitle "For quick project startup"}]
        [:&gt; paper/Card.Content
         [:&gt; rn/View {:style (.-themeSwitch styles)}
          [:&gt; paper/Text {:style {:color (-&gt;&gt; theme .-colors .-accent)}}
           "Dark mode"]
          [:&gt; paper/Switch {:value           (= theme-selection :dark) ;; &lt;------------------------- use of that app state value
                            :on-value-change #(&gt;evt [:set-theme (if (= theme-selection :dark)
                                                                  :light
                                                                  :dark)])}]]
         [:&gt; paper/Paragraph (str "Version: " version)]]]]])))
</code></pre><h3>Specter</h3><p>For any app that gets past the <em>toy</em> stage the app-db (state) is going to get <em>complicated</em>. For that you will want <a href="https://github.com/redplanetlabs/specter">Specter</a>. It makes dealing with state objects easier. Deeply nested values in state are messy to deal with in just plain Clojure. It's still better than Object Oriented Programming but Specter brings it to the next level. The examples in this repo are super simple so it might not be apparent. But check out this from a more <em>involved</em> project I've been working on.</p><pre><code class="language-clojure">(defn apply-pattern-to-displayed-day [db [_ {:keys [pattern-id new-periods]}]]
  (let [
          ;; Some stuff removed here for visual brevity
       ]

    ;; The basic app-db structure is 
    (comment 
      {:patterns [
                  ;; A list of objects that contian templates for periods from various buckets
                 ]
       :buckets 
        {#uuid for-each-bucket-as-index 
          {:id #uuid same-uuid-as-the-index
           :meta "data"
           :periods {#uuid for-each-period-as-index {:id #uuid same-uuid-as-the-index
                                                     :meta "data"}}}}})

    (-&gt;&gt; db
         (transform
          [:buckets sp/MAP-VALS
           #(some? (some #{(:id %)} all-bucket-ids))
           (sp/collect-one (sp/submap [:id]))
           :periods]
           
           ;; This transform path dives right into the periods map and brings along the id of the bucket.
           ;; THIS IS THE MAGIC!
           ;; We start with a crazy nested and indexed app-db map and can dive right into it.
           ;; From there we run a function on the value(s) we target that also has data from higher up the nesting.
           ;; And it reconstructs the big nested object for the return value of the `transform`
           ;; It's amazing.

          (fn [bucket old-period-map]
            ;; This is where we take all the template periods from the pattern and find the ones that should be applied to this bucket's periods
            )))))
</code></pre><h3>CSK</h3><p><a href="https://clj-commons.org/camel-snake-kebab/">Camel-snake-kebab</a> is a nice little convenience. Reagent does a great job of converting component parameters from kebab-case to camelCase for wrapped React components. There are some spots where you will want to use this library to do the same thing. In this example it is for the style sheets. In <code>src/main/new_project_name/app.cljs</code> you can see it's use to allow style properties to be referenced in camel case.</p><pre><code class="language-clojure">(def styles
  ^js (-&gt; {:surface
           {:flex           1
            :justify-content "center"}

           :theme-switch
           {:flex-direction  "row"
            :justify-content "space-between"}}
          (#(cske/transform-keys csk/-&gt;camelCase %))
          (clj-&gt;js)
          (rn/StyleSheet.create)))
</code></pre><h3>Component library</h3><p><a href="https://callstack.github.io/react-native-paper/getting-started.html">React Native paper</a> is an excellent component library.</p><h3>Unit tests</h3><p>Another example this repo provides, although not a library, is unit tests. This is tricky in an Expo project because you will likely want to run unit tests in a ci/cd pipeline. Which means you will probably want a runtime in Node, not a native app running React Native. There are examples of handler and subscription unit tests. They utilize shadow-cljs <a href="https://shadow-cljs.github.io/docs/UsersGuide.html#target-node-test">node tests configuration</a>. Check out <code>src/test/new_project_name/</code> for the test files. They use a different build configuration in <code>shadow-cljs.edn</code>.</p><h2>Footnotes</h2><p>[^1]: <em>Push notifications are available for Android browsers.</em></p><p>[^2]: <em>I know, you don't need a gui, you know the command line. Previous git clients suck, yes. But this one is good. Everyone I've gotten to try it, even the most steadfast cli advocates, stick with it. The visual information density is high. That cannot be matched by the cli. The buttons pretty clearly map to cli commands and the client even has a log to show you what every gui action does on the command line. Use this client.</em></p>
</div>

<div id="post-tags">
    <b>Tags: </b>
    
    <a href="/tags/cljs">cljs</a>
    
    <a href="/tags/expo">expo</a>
    
    <a href="/tags/shadow-cljs">shadow-cljs</a>
    
</div>


    <div id="prev-next">
        
        <a href="/2020-04-05-stealing-with-deps">&laquo; ðŸ’Ž Stealing with deps.edn</a>
        
        
        <a class="right" href="/2019-07-21-hello-world">Hello World &raquo;</a>
        
    </div>

    


</div>

            </div>
        </div>

        <div class="col-md-3">
            <div id="sidebar">
                <h3>Links</h3>
                <ul id="links">
                  <li>
                    <i class="fa fa-linkedin" aria-hidden="true"></i>
                    <a href="https://www.linkedin.com/in/jgoodhcg/">Linked In</a>
                  </li>
                  <li>
                    <i class="fa fa-github" aria-hidden="true"></i>
                    <a href="https://github.com/jgoodhcg">Github</a>
                  </li>
                  <li>
                    <i class="fa fa-twitter" aria-hidden="true"></i>
                    <a href="https://twitter.com/jgoodhcg">Twitter</a>
                  </li>
                  
                </ul>
                
                <div id="recent">
                    <h3>Recent Posts</h3>
                    <ul>
                        
                        <li><a href="/2020-09-03-playing-with-vega-lite-pt-1">ðŸ“ˆ Vega-Lite Fun Pt-1</a></li>
                        
                        <li><a href="/2020-04-05-stealing-with-deps">ðŸ’Ž Stealing with deps.edn</a></li>
                        
                        <li><a href="/2020-01-26-expo-shadow-cljs-starter">A template for Expo apps with Shadow CLJS</a></li>
                        
                    </ul>
                </div>
                
                
                <div id="tags">
                    <h3>Tags</h3>
                    <ul>
                        
                        <li><a href="/tags/clojure">clojure</a></li>
                        
                        <li><a href="/tags/cljs">cljs</a></li>
                        
                        <li><a href="/tags/clj">clj</a></li>
                        
                        <li><a href="/tags/vega">vega</a></li>
                        
                        <li><a href="/tags/oz">oz</a></li>
                        
                        <li><a href="/tags/expo">expo</a></li>
                        
                        <li><a href="/tags/vega-lite">vega-lite</a></li>
                        
                        <li><a href="/tags/shadow-cljs">shadow-cljs</a></li>
                        
                        <li><a href="/tags/create-kit">create-kit</a></li>
                        
                        <li><a href="/tags/npm">npm</a></li>
                        
                    </ul>
                </div>
                
            </div>
        </div>
    </div>
    <footer>Copyright &copy; 2020 Justin Good
        <p style="text-align: center;">Powered by <a href="http://cryogenweb.org">Cryogen</a></p></footer>
</div>
<script src="//code.jquery.com/jquery-1.11.0.min.js"></script>
<script src="//maxcdn.bootstrapcdn.com/bootstrap/3.3.0/js/bootstrap.min.js"></script>
<script src="/js/highlight.pack.js" type="text/javascript"></script>
<script>hljs.initHighlightingOnLoad();</script>


</body>
</html>
